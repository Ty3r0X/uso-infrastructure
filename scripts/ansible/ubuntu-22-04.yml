- name: Provision image
  hosts: default
  become: true

  tasks:
    - import_tasks: _common.yml

    - name: Clean cloud-init artifacts
      command:
        cmd: cloud-init clean

    - name: Purge the unnecessary packages
      apt:
        name:
          - snapd
          - linux-firmware
          - linux-headers*
          - cloud-init*
        state: absent
        purge: yes
        autoremove: yes

    - name: Upgrade all packages
      apt:
        upgrade: full

    - name: Update grub configuration
      command: update-grub2

    - name: Configure Git
      shell: |
        git config --global color.ui auto
        git config --global user.name 'Student USO VM User'
        git config --global user.email 'student@stud.acs.upb.ro'

    - name: Clone Razvan's scripts and configs in the Documents folder
      command:
        cmd: git clone https://github.com/razvand/snippets /home/student/Documents/snippets.git

    - name: Make Vim default editor
      command:
        cmd: update-alternatives --set editor /usr/bin/vim.basic

    - name: Add aditional Vim configuration
      shell: |
        cp /usr/share/vim/vim81/vimrc_example.vim /etc/vim/vimrc
        mkdir -p /home/student/.vim/bkup
        cp /home/student/Documents/snippets.git/config/vim/vimrc_no_cscope /home/student/.vimrc
        cp -r /home/student/Documents/snippets.git/config/vim/ftplugin/ /home/student/.vim/

    - name: Add aditional Emacs configuration
      command:
        cmd: cp /home/student/Documents/snippets.git/config/emacs/emacs-to-deploy.el /home/student/.emacs

    - name: Add aditional Bash aliases
      command:
        cmd: cp /home/student/Documents/snippets.git/config/bash/bash_aliases_deploy_systemd /home/student/.bash_aliases

    - name: Clone USO repository
      command:
        cmd: git clone https://github.com/systems-cs-pub-ro/uso-lab uso-lab.git

    - import_tasks: _disk_clean.yml
